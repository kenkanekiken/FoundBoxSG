@page "/matches"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.EntityFrameworkCore
@using FoundBoxSG.Domain
@inject IDbContextFactory<FoundBoxSG.Data.FoundBoxSGContext> DbFactory
@inject AuthenticationStateProvider authenticationStateProvider
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Matches</PageTitle>

<div class="container-fluid">
    <div class="pt-4 px-4 fs-2">Your Case</div>
    <div class="px-4 fs-5">Keep track of all your cases.</div>
    @if (isAdmin)
    {
        <span class="px-4 text-muted">Admin: Able to viewing all listings available</span>
    }
</div>

<div class="container-fluid">
    <div class="d-flex justify-content-start px-4 py-4 gap-2">

        <button class="fs-6 bg-white border-0 p-0"
                @onclick="() => SetTab(ListingTab.Lost)">
            <div class="d-flex align-items-center">
                <div class="pe-2 @(activeTab == ListingTab.Lost ? "fw-semibold border-bottom border-2 border-dark" : "opacity-50")">
                    Lost Items
                </div>
                <div class="bg-black bg-opacity-10 rounded-2 px-1">@LostCount</div>
            </div>
        </button>

        <button class="fs-6 bg-white border-0 p-0"
                @onclick="() => SetTab(ListingTab.Found)">
            <div class="d-flex align-items-center">
                <div class="pe-2 @(activeTab == ListingTab.Found ? "fw-semibold border-bottom border-2 border-dark" : "opacity-50")">
                    Found Items
                </div>
                <div class="bg-black bg-opacity-10 rounded-2 px-1">@FoundCount</div>
            </div>
        </button>
        @if (isAdmin) 
        {
        <button class="fs-6 bg-white border-0 p-0"
                @onclick="() => SetTab(ListingTab.Closed)">
            <div class="d-flex align-items-center">
                <div class="pe-2 @(activeTab == ListingTab.Closed ? "fw-semibold border-bottom border-2 border-dark" : "opacity-50")">
                    Closed Cases
                </div>
                <div class="bg-black bg-opacity-10 rounded-2 px-1">@ClosedCount</div>
            </div>
        </button>
        }
    </div>
</div>

@if (!isLoaded)
{
    <div class="px-4 text-muted">Loading…</div>
}
else if (!UserListings.Any())
{
    <div class="px-4 text-muted">No cases yet.</div>
}
else
{
    @foreach (var item in Filtered)
    {
        <div class="container-fluid m-0 px-4 pb-2">
            <div class="p-3 rounded-4 bg-secondary bg-opacity-10">
                <div class="d-flex align-items-center gap-3">

                    <div class="rounded-circle bg-secondary bg-opacity-25 d-flex align-items-center justify-content-center flex-shrink-0"
                         style="width:70px;height:70px;">
                        <i class="bi bi-search fs-3"></i>
                    </div>

                    <div class="flex-grow-1 d-flex flex-column flex-md-row justify-content-between align-items-start">
                        <div>
                            <div class="fw-semibold pb-3">@item.Title</div>
                            <div class="text-muted small pb-3">@item.ItemCategory</div>
                            <div class="text-muted small pb-3">Item ID: @item.Id</div>
                            <div class="text-muted small">Posted @item.DateCreated</div>
                        </div>

                        @if (isAdmin)
                        {
                            <div class="row mt-2 mt-md-0">
                                <div class="py-1 col-12">
                                    <button class="btn btn-secondary border-0 rounded-2 w-100"
                                            @onclick="() => ViewCase(item)">
                                        View Case
                                    </button>
                                </div>
                                <div class="py-1 col-12">
                                    <button class="btn btn-secondary border-0 rounded-2 w-100"
                                            @onclick="() => DeleteCase(item)">
                                        Delete Case
                                    </button>
                                </div>
                            </div>
                        } else
                        {
                            <div class="row mt-2 mt-md-0">
                                <div class="py-1 col-12">
                                    <button class="btn btn-secondary border-0 rounded-2 w-100"
                                            @onclick="() => ViewCase(item)">
                                        View Case
                                    </button>
                                </div>
                                <div class="py-1 col-12">
                                    <button class="btn btn-secondary border-0 rounded-2 w-100"
                                            @onclick="() => EditCase(item)">
                                        Edit Case
                                    </button>
                                </div>
                                <div class="py-1 col-12">
                                    <button class="btn btn-secondary border-0 rounded-2 w-100"
                                            @onclick="() => DeleteCase(item)">
                                        Delete Case
                                    </button>
                                </div>
                            </div>
                        }
                    </div>

                </div>
            </div>
        </div>
    }
}

@if (showModal && selected is not null)
{
    <div class="modal-backdrop fade show"></div>

    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title">@selected.Title</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>

                <div class="modal-body">
                    <div class="text-muted mb-2">📍 @selected.Location</div>
                    <div class="text-muted mb-2">@selected.ItemCategory</div>
                    <div class="mb-3"><small class="text-muted">Posted @selected.DateCreated</small></div>

                    @if (selected.Images is not null && selected.Images.Any())
                    {
                        <div class="mb-3">
                            <div class="fw-semibold mb-2">Images</div>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var img in selected.Images)
                                {
                                    <img src="@img" style="width:140px;height:140px;object-fit:cover;" class="rounded-3 border" />
                                }
                            </div>
                        </div>
                    }

                    <div class="text-muted mb-2">ID: @selected.Id</div>
                    <div class="text-muted mb-2">Brand: @selected.Brand</div>
                    <div class="text-muted mb-2">Color: @selected.Color</div>
                    <div class="text-muted mb-2">Unique Feature: @selected.UniqueFeatures</div>

                    <div class="fw-semibold mb-2">Description:</div>
                    <div>@selected.Description</div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private enum ListingTab { Lost, Found, Closed }
    private ListingTab activeTab = ListingTab.Lost;

    private bool isLoaded;
    private bool isAdmin;

    private List<Listings> UserListings = new();

    private bool showModal;
    private Listings? selected;

    private int LostCount => UserListings.Count(x => !x.IsClose && string.Equals(x.ListingType, "Lost", StringComparison.OrdinalIgnoreCase));
    private int FoundCount => UserListings.Count(x => !x.IsClose && string.Equals(x.ListingType, "Found", StringComparison.OrdinalIgnoreCase));
    private int ClosedCount => UserListings.Count(x => x.IsClose);

    // private IEnumerable<Listings> Filtered =>
    //     activeTab == ListingTab.Lost
    //         ? UserListings.Where(x => string.Equals(x.ListingType, "Lost", StringComparison.OrdinalIgnoreCase))
    //                      .OrderByDescending(x => x.DateCreated)
    //         : UserListings.Where(x => string.Equals(x.ListingType, "Found", StringComparison.OrdinalIgnoreCase))
    //                      .OrderByDescending(x => x.DateCreated);

    private IEnumerable<Listings> Filtered =>
    activeTab switch
    {
        ListingTab.Lost =>
            UserListings
                .Where(x => !x.IsClose && string.Equals(x.ListingType, "Lost", StringComparison.OrdinalIgnoreCase))
                .OrderByDescending(x => x.DateCreated),

        ListingTab.Found =>
            UserListings
                .Where(x => !x.IsClose && string.Equals(x.ListingType, "Found", StringComparison.OrdinalIgnoreCase))
                .OrderByDescending(x => x.DateCreated),

        ListingTab.Closed =>
            UserListings
                .Where(x => x.IsClose)
                .OrderByDescending(x => x.DateCreated),

        _ => Enumerable.Empty<Listings>()
    };

    protected override async Task OnInitializedAsync()
    {
        isLoaded = false;

        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Admin role check
        isAdmin = user.IsInRole("Administrator");

        using var context = await DbFactory.CreateDbContextAsync();

        if (isAdmin)
        {
            UserListings = await context.Listings
                .ToListAsync();

            isLoaded = true;
            return;
        }



        // Normal user: map Identity -> AppUser int (nullable safe)
        var aspNetUserId = user.FindFirstValue(ClaimTypes.NameIdentifier);

        if (string.IsNullOrWhiteSpace(aspNetUserId))
        {
            UserListings = new();
            isLoaded = true;
            return;
        }

        var appUserId = await context.AppUser
            .Where(au => au.AspNetUserId == aspNetUserId)
            .Select(au => (int?)au.Id)
            .SingleOrDefaultAsync();

        if (appUserId is null)
        {
            // user exists in Identity but not in AppUser table
            UserListings = new();
            isLoaded = true;
            return;
        }

        UserListings = await context.Listings
            .Where(l => l.UserId == appUserId.Value && !l.IsClose) 
            .ToListAsync();

        isLoaded = true;
    }

    private void SetTab(ListingTab tab) => activeTab = tab;

    private async Task ViewCase(Listings item)
    {
        using var context = await DbFactory.CreateDbContextAsync();
        selected = await context.Listings.FirstOrDefaultAsync(l => l.Id == item.Id);
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        selected = null;
    }

    private void EditCase(Listings item)
    {
        NavigationManager.NavigateTo($"/listings/edit?id={item.Id}");
    }

    private async Task DeleteCase(Listings item)
    {
        using var context = await DbFactory.CreateDbContextAsync();

        // reload entity so EF can track it safely
        var entity = await context.Listings.FirstOrDefaultAsync(l => l.Id == item.Id);
        if (entity is null) return;

        context.Listings.Remove(entity);
        await context.SaveChangesAsync();

        UserListings.RemoveAll(x => x.Id == item.Id);

        if (selected?.Id == item.Id)
            CloseModal();
    }
}
