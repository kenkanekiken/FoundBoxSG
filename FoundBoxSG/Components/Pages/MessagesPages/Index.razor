@page "/messages"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using FoundBoxSG.Domain
@using FoundBoxSG.Data
@using FoundBoxSG.ViewModels
@using System.Security.Claims
@inject AuthenticationStateProvider authenticationStateProvider
@inject IDbContextFactory<FoundBoxSG.Data.FoundBoxSGContext> DbFactory
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Messages</PageTitle>

@if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-danger m-3">
        <pre class="m-0">@_error</pre>
    </div>
}

<div class="container-fluid py-4">
    <h2 class="m-0 pt-1 pb-3 px-4 fw-normal">All Chats</h2>
    @if (isAdmin)
    {
        <span class="px-4 text-muted">Admin: Able to view all messages</span>
    }
</div>

@if (!isLoaded)
{
    <div class="px-4 text-muted">Loading…</div>
}
else if (Chats.Count == 0)
{
    <div class="px-4 text-muted">No chats yet.</div>
}
else
{
    @foreach (var chat in Chats)
    {
        <div class="container-fluid m-0 px-4 pb-2">
            <div class="col-12 p-3 rounded-4 bg-secondary bg-opacity-10 text-start"
            role="button"
            style="cursor:pointer;"
            @onclick="() => OpenChat(chat.MatchId, chat.ListingOwnerId)">

                <div class="d-flex align-items-center gap-3">
                    <!-- Left circle icon -->
                    @if (!string.IsNullOrEmpty(chat.OtherUserProfileImageUrl))
                    {
                        <img src= "@chat.OtherUserProfileImageUrl"
                        alt="User Profile"
                        class = "rounded-circle flex-shrink-0"
                        style = "width: 56px; height: 56px"/>
                    }
                    else
                    {
                        <div class="rounded-circle bg-secondary bg-opacity-25 d-flex align-items-center justify-content-center flex-shrink-0"
                             style="width:56px;height:56px;">
                            <i class="bi bi-person-fill fs-3"></i>
                        </div>
                    }

                    <!-- Right content -->
                    <div class="flex-grow-1 d-flex flex-column flex-md-row justify-content-between align-items-start">
                        <div>
                            <div class="fw-semibold">@chat.ListingTitle</div>
                            <div class=" text-secondary small fw-bold">Chat with: @chat.OtherUserName</div>
                            <div class="text-muted small">Listing ID: @chat.ListingId</div>
                            <div class="text-muted small">Matched at @chat.LastUpdated</div>
                        </div>

                        <!-- Close case -->
                        <div class="text-md-end mt-2 mt-md-0" @onclick:stopPropagation="true">
                            @if (myAppUserId > 0 && chat.ListingOwnerId == myAppUserId)
                            {
                                <button class="btn btn-sm btn-outline-secondary"
                                        @onclick="() => CloseCase(chat.MatchId)">
                                    Close Case
                                </button>
                            }
                        </div>

                    </div>
                </div>

            </div>
        </div>
    }
}

@if (showModal)
{
    <div class="modal-backdrop fade show"></div>

    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title">@modalHeaderTitle</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>

                <div class="modal-body" style="max-height:70vh; overflow:auto;">
                    @if (modalLoading)
                    {
                        <div class="text-muted">Loading chat…</div>
                    }
                    else if (!string.IsNullOrEmpty(modalError))
                    {
                        <div class="text-danger">@modalError</div>
                    }
                    else if (modalMsgs.Count == 0)
                    {
                        <div class="text-muted">No messages yet.</div>
                    }
                    else
                    {
                        @foreach (var m in modalMsgs)
                        {
                            bool isRight;

                            if (!isAdmin)
                            {
                                // not used normally (users navigate), but safe anyway
                                isRight = (m.SenderUserId == myAppUserId);
                            }
                            else
                            {
                                // Admin: matcher on right, listing owner on left
                                isRight = (m.SenderUserId == modalMatcherId);
                            }

                            <div class="d-flex mb-2" style="justify-content:@(isRight ? "flex-end" : "flex-start")">
                                <div class="px-3 py-2 rounded-4 @(isRight ? "bg-dark text-white" : "bg-secondary bg-opacity-10")"
                                     style="max-width:70%;">
                                    <div style="white-space: pre-wrap; word-break: break-word;">
                                        @m.Content
                                    </div>
                                    <div class="small opacity-75 mt-1">
                                        @(m.DateCreated?.ToString("dd MMM yyyy, HH:mm") ?? "")
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoaded;
    private bool isAdmin;
    private int myAppUserId;
    private string? _error;
    private string? OtherUserName;
    private int selectedMatchId;
    private int selectedListingOwnerId;

    private List<ChatRow> Chats = new();

    // modal state (admin only)
    private bool showModal;
    private bool modalLoading;
    private string modalHeaderTitle = "Chat";
    private string? modalError;
    private int modalMatcherId;
    private int modalListingOwnerId;
    private List<Messages> modalMsgs = new();

    private class ChatRow
    {
        public int MatchId { get; set; }
        public int ListingId { get; set; }
        public string? ListingTitle { get; set; }
        public int ListingOwnerId { get; set; }
        public int OtherUserId { get; set; }
        public DateTime? LastUpdated { get; set; }
        public string? OtherUserProfileImageUrl { get; set; }
        public string? OtherUserName { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var context = await DbFactory.CreateDbContextAsync();

            var auth = (await authenticationStateProvider.GetAuthenticationStateAsync()).User;

            // ✅ Your real role name from AspNetRoles is "Administrator"
            isAdmin = auth.IsInRole("Administrator");

            // current aspNet user id
            var aspNetUserId = auth.FindFirstValue(ClaimTypes.NameIdentifier);

            // map to AppUser int id (admin may also have an AppUser row, but not required for viewing all chats)
            myAppUserId = await context.AppUser
                .Where(u => u.AspNetUserId == aspNetUserId)
                .Select(u => u.Id)
                .SingleOrDefaultAsync();

            // ✅ Admin sees ALL chats
            if (isAdmin)
            {
                Chats = await context.Matches
                    .Join(context.Listings,
                        m => m.ListingId,
                        l => l.Id,
                        (m, l) => new { m, l })
                    .Where(x => !x.l.IsClose) 
                    .Join(context.AppUser, x => x.m.MatcherUserId, u => u.Id, (x, u) => new { x.m, x.l, u })
                    .Join(context.Users,
                      combined => combined.u.AspNetUserId,
                      identity => identity.Id,
                      (combined, identity) => new ChatRow
                      {
                          MatchId = combined.m.Id,
                          ListingId = combined.l.Id,
                          ListingOwnerId = combined.l.UserId,
                          ListingTitle = combined.l.Title ?? "(No title)",
                          OtherUserId = combined.u.Id,
                          LastUpdated = combined.m.DateModified ?? combined.m.DateCreated,
                          OtherUserProfileImageUrl = combined.u.ProfileImageUrl,
                          OtherUserName = identity.FullName
                      })
                    .OrderByDescending(x => x.LastUpdated)
                    .ToListAsync();


                isLoaded = true;
                return;
            }

            // ✅ Normal user sees only their chats
            if (myAppUserId == 0)
            {
                Chats = new();
                isLoaded = true;
                return;
            }

            // A. Chats where the current user is the LISTING OWNER (The other user is the Matcher)
            var asListingOwner = context.Matches
            .Join(context.Listings, m => m.ListingId, l => l.Id, (m, l) => new { m, l })
            .Where(x => x.l.UserId == myAppUserId && !x.l.IsClose)
            .Join(context.AppUser, x => x.m.MatcherUserId, u => u.Id, (x, u) => new { x.m, x.l, u })
            .Join(context.Users, c => c.u.AspNetUserId, i => i.Id, (c, i) => new ChatRow
            {
                MatchId = c.m.Id,
                ListingId = c.l.Id,
                ListingOwnerId = c.l.UserId,
                ListingTitle = c.l.Title,
                OtherUserId = c.u.Id,
                LastUpdated = c.m.DateModified ?? c.m.DateCreated,
                OtherUserProfileImageUrl = c.u.ProfileImageUrl,
                OtherUserName = i.FullName
            });
            var asMatcher = context.Matches
            .Where(m => m.MatcherUserId == myAppUserId)
            .Join(context.Listings, m => m.ListingId, l => l.Id, (m, l) => new { m, l })
            .Where(x => !x.l.IsClose) 
            .Join(context.AppUser, x => x.l.UserId, u => u.Id, (x, u) => new { x.m, x.l, u })
            .Join(context.Users, c => c.u.AspNetUserId, i => i.Id, (c, i) => new ChatRow
            {
                MatchId = c.m.Id,
                ListingId = c.l.Id,
                ListingOwnerId = c.l.UserId,
                ListingTitle = c.l.Title,
                OtherUserId = c.u.Id,
                LastUpdated = c.m.DateModified ?? c.m.DateCreated,
                OtherUserProfileImageUrl = c.u.ProfileImageUrl,
                OtherUserName = i.FullName
            });

            Chats = await asListingOwner
            .Union(asMatcher)
            .OrderByDescending(x => x.LastUpdated)
            .ToListAsync();

            isLoaded = true;
        }
        catch (Exception ex)
        {
            _error = ex.ToString();
            isLoaded = true;
        }
    }

    // ✅ This is the "admin popup vs user navigate" behaviour you want
    private async Task OpenChat(int matchId, int listingOwnerId)
    {
        selectedMatchId = matchId;

        if (isAdmin)
        {
            await ViewChatModal(matchId); // popup modal
        }
        else
        {
            NavigationManager.NavigateTo($"/messages/chat/{matchId}"); // go to chat page
        }
    }

    // Admin modal loader
    private async Task ViewChatModal(int matchId)
    {
        showModal = true;
        modalLoading = true;
        modalError = null;
        modalMsgs.Clear();
        modalHeaderTitle = "Chat";

        try
        {
            using var context = await DbFactory.CreateDbContextAsync();

            var match = await context.Matches.FirstOrDefaultAsync(m => m.Id == matchId);
            if (match is null)
            {
                modalError = "Match not found.";
                return;
            }

            modalMatcherId = match.MatcherUserId;

            var listing = await context.Listings.FirstOrDefaultAsync(l => l.Id == match.ListingId);
            if (listing is null)
            {
                modalError = "Listing not found.";
                return;
            }

            modalListingOwnerId = listing.UserId;
            modalHeaderTitle = listing.Title ?? "Chat";

            modalMsgs = await context.Messages
                .Where(m => m.MatchId == matchId)
                .OrderBy(m => m.DateCreated)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            modalError = ex.ToString();
        }
        finally
        {
            modalLoading = false;
        }
    }

    private void CloseModal()
    {
        showModal = false;
        modalMsgs.Clear();
        modalError = null;
        modalHeaderTitle = "Chat";
    }

    private async Task CloseCase(int matchId)
    {
        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();

            var match = await context.Matches
                .FirstOrDefaultAsync(m => m.Id == matchId);

            if (match is null)
                return;

            var listing = await context.Listings
                .FirstOrDefaultAsync(l => l.Id == match.ListingId);

            if (listing is null)
                return;

            // 🔒 AUTHORIZATION CHECK
            if (listing.UserId != myAppUserId)
            {
                // Not the owner → do nothing (or log)
                return;
            }

            listing.IsClose = true;

            match.DateModified = DateTime.Now;

            await context.SaveChangesAsync();

            Chats = Chats
                .Where(c => c.MatchId != matchId)
                .ToList();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            _error = ex.ToString();
        }
    }

}
