@page "/listings/details"
@using FoundBoxSG.Data
@using Microsoft.EntityFrameworkCore
@using FoundBoxSG.Domain
@inject IDbContextFactory<FoundBoxSG.Data.FoundBoxSGContext> DbFactory
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider authenticationStateProvider
@inject UserManager<FoundBoxSGUser> UserManager

@using Microsoft.AspNetCore.Identity

<PageTitle>Details</PageTitle>

<div class="container-fluid">
    @if (Item is null)
    {
        <div class="text-muted p-4">
            Loading listing details…
        </div>
    }
    else
    {
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <a href="/appusers"
                       class="btn btn-link text-decoration-none px-0 me-3">
                        <i class="bi bi-arrow-left fs-4"></i>
                    </a>
                </div>
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h3 class="mb-1">@Item.Title</h3>
                        <div class="text-muted">
                            📍 @Item.Location
                        </div>
                    </div>

                    <div class="text-end">
                        @if (Item.IsClose)
                        {
                            <span class="badge bg-secondary">Closed</span>
                        }
                        else if (Item.ListingType == "Lost")
                        {
                            <span class="badge bg-danger">Lost</span>
                        }
                        else
                        {
                            <span class="badge bg-success">Found</span>
                        }
                    </div>
                </div>

                <!-- Images -->
                @if (Item.Images is not null && Item.Images.Any())
                {
                    <div id="listingCarousel" class="carousel slide mb-4">
                        <div class="carousel-inner">
                            @for (int i = 0; i < Item.Images.Count; i++)
                            {
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@Item.Images[i]"
                                         class="d-block w-100 rounded"
                                         style="object-fit:contain; height:350px;" />
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Info Grid -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="border rounded p-3 h-100">
                            <div class="fw-semibold mb-2">Item Information</div>
                            <div><strong>Category:</strong> @Item.ItemCategory</div>
                            <div><strong>Brand:</strong> @Item.Brand</div>
                            <div><strong>Color:</strong> @Item.Color</div>
                            <div><strong>Unique Features:</strong> @Item.UniqueFeatures</div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="border rounded p-3 h-100">
                            <div class="fw-semibold mb-2">Case Details</div>
                            <div><strong>Listing Type:</strong> @Item.ListingType</div>
                            <div><strong>Date Created:</strong> @Item.DateCreated</div>
                            <div><strong>Last Updated:</strong> @Item.DateModified</div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <div class="fw-semibold">Description</div>
                    <div class="border rounded p-3 bg-light">
                        @Item.Description
                    </div>
                </div>

            </div>
    }

    </div>


@code {
    [Parameter] public Listings? Item { get; set; }
    private int appUserId;
    private string? PosterProfileImageUri;
    private string? PosterName;

    [SupplyParameterFromQuery]
    private int Id { get; set; }
    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Item = await context.Listings.FirstOrDefaultAsync(m => m.Id == Id);

        if (Item is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }
    protected override async Task OnParametersSetAsync()
    {
        if (Item != null)
        {
            using var context = await DbFactory.CreateDbContextAsync();
            var auth = (await authenticationStateProvider.GetAuthenticationStateAsync()).User;
            var aspNetUserId = auth.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            appUserId = await context.AppUser
                .Where(u => u.AspNetUserId == aspNetUserId)
                .Select(u => u.Id)
                .SingleAsync();


            var posterAppUser = await context.AppUser
                .Where(u => u.Id == Item.UserId)
                .Select(u => new
                {
                    u.AspNetUserId,
                    u.ProfileImageUrl
                }

                ).SingleOrDefaultAsync();

            if (posterAppUser is not null)
            {
                PosterProfileImageUri = posterAppUser.ProfileImageUrl;

                if (!string.IsNullOrEmpty(posterAppUser.AspNetUserId))
                {
                    var posterIdentityUser = await UserManager.FindByIdAsync(posterAppUser.AspNetUserId);
                    PosterName = posterIdentityUser?.FullName;
                }
            }

        }
    }
}

