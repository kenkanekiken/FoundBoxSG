@using FoundBoxSG.Domain
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<FoundBoxSG.Data.FoundBoxSGContext> DbFactory
@inject AuthenticationStateProvider authenticationStateProvider
@inject NavigationManager NavigationManager

@if (Item is null)
{
    <!-- Right side when nothing is selected -->
    <div class="col-md-9 d-none d-md-block px-5">
        <p class="text-muted pt-5">
            Select a listing on the left to view its details.
        </p>
    </div>
}
else
{
    <!-- Right side when an item is selected -->
    <div class="col-md-9 d-none d-md-block px-5">
        <h2>@Item.Title</h2>
        <div class="fw-bold">@Item.ItemCategory</div>
        <div>📍 @Item.Location</div>
        <small class="text-muted">
            Posted @Item.DateCreated
        </small>

        <div class="py-4">
            <!-- Change the button's onclick to pass the required listingId parameter -->
            @if (Item.UserId != appUserId)
            {
                <button class="btn btn-dark" @onclick="() => ClaimItem(Item.Id)">
                    Claim item
                </button>
            }

        </div>

        <!-- You can later bind this to Item.ImageUrl or a list of images -->
        <div id="carouselExampleDark" class="carousel carousel-dark slide">
            <div class="carousel-indicators">
                @if (Item.Images is not null && Item.Images.Any())
                {
                    @for (int i = 0; i < Item.Images.Count; i++)
                    {
                        <button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="@i"
                                class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" aria-label="Slide @(i + 1)"></button>
                    }
                }
            </div>

            <div class="carousel-inner">
                @if (Item.Images is not null && Item.Images.Any())
                {
                    @for (int i = 0; i < Item.Images.Count; i++)
                    {
                    <div class = "carousel-item @(i == 0 ? "active" : "")" data-bs-interval="3000">
                        <img src="@Item.Images[i]" class="d-block w-100" style="object-fit:contain; height: 400px;" alt="Item Image">
                    </div>    
                    }
                }
                else
                {
                    <div class="carousel-item active">
                        <img src="/images/placeholder-no-image.png" class="d-block w-100" alt="No Image Available">
                    </div>
                }

            </div>
            @if (Item.Images is not null && Item.Images.Count > 1)
            {
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            }
        </div>

        <div class="pt-4">Item description</div>
        <div class="border"></div>

        <div class="pt-3 fw-bold">ID: @Item.Id</div>

        <div class="pt-3 fw-bold">Brand: @Item.Brand</div>

        <div class="pt-3 fw-bold">Color: @Item.Color</div>

        <div class="pt-3 fw-bold">Unqiue Feature: @Item.UniqueFeatures</div>

        <div class="pt-3 fw-bold">Description:</div>
        <div class="pt-3 pb-5">
            @Item.Description
        </div>
    </div>
}

@code {
    [Parameter] public Listings? Item { get; set; }
    private int appUserId;

    protected override async Task OnParametersSetAsync()
    {
        if (Item != null)
        {
            using var context = await DbFactory.CreateDbContextAsync();
            var auth = (await authenticationStateProvider.GetAuthenticationStateAsync()).User;
            var aspNetUserId = auth.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            appUserId = await context.AppUser
                .Where(u => u.AspNetUserId == aspNetUserId)
                .Select(u => u.Id)
                .SingleAsync();
        }
    }

    private async Task ClaimItem(int listingId)
    {
        using var context = await DbFactory.CreateDbContextAsync();

        var auth = (await authenticationStateProvider.GetAuthenticationStateAsync()).User;
        var aspNetUserId = auth.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        var myAppUserId = await context.AppUser
            .Where(u => u.AspNetUserId == aspNetUserId)
            .Select(u => u.Id)
            .SingleAsync();

        var listing = await context.Listings.FirstAsync(l => l.Id == listingId);

        if (listing.UserId == myAppUserId)
            return; // or show message: can't claim your own listing

        var match = await context.Matches.FirstOrDefaultAsync(m =>
            m.ListingId == listingId && m.MatcherUserId == myAppUserId);

        if (match == null)
        {
            match = new Matches
            {
                ListingId = listingId,
                MatcherUserId = myAppUserId,
                DateCreated = DateTime.Now,
                DateModified = DateTime.Now
            };
            context.Matches.Add(match);
            await context.SaveChangesAsync();
        }

        NavigationManager.NavigateTo($"/messages?matchId={match.Id}");
    }

}
