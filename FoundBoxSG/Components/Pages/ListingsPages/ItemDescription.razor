@using FoundBoxSG.Domain
@using FoundBoxSG.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<FoundBoxSG.Data.FoundBoxSGContext> DbFactory
@inject AuthenticationStateProvider authenticationStateProvider
@inject NavigationManager NavigationManager
@inject UserManager<FoundBoxSGUser> UserManager

@if (Item is null)
{
    <!-- Right side when nothing is selected -->
    <div class="col-md-9 d-none d-md-block px-5">
        <p class="text-muted pt-5">
            Select a listing on the left to view its details.
        </p>
    </div>
}
else
{
    <!-- Right side when an item is selected -->
    <div class="col-md-9 d-none d-md-block px-5">
        <div class="d-flex align-items-center mb-2">
            <div class="me-3">
            @if (!string.IsNullOrEmpty(PosterProfileImageUri))
            {
                <img Src="@PosterProfileImageUri"
                     alt="Poster Profile Photo"
                     class="rounded-circle border border-dark border-1"
                     style="width: 50px; height: 50px; object-fit: cover; " />
            }
            else
            {
                    <div class="bg-light text-secondary rounded-circle d-flex align-items-center justify-content-center border border-dark border-1"
                         style="width: 50px; height: 50px; font-size: 1.5rem;">
                        👤
                    </div>
            }
        </div>
     
        <h2>@Item.Title</h2>
        </div>
        <div class="fw-bold">@Item.ItemCategory</div>
        <div>📍 @Item.Location</div>
        <small class="text-muted">
            Posted @Item.DateCreated 
        </small>
        <div class="text-muted">
            by @PosterName
        </div>

        <div class="py-4">
            <!-- Change the button's onclick to pass the required listingId parameter -->
            @if (Item.UserId != appUserId)
            {
                <button class="btn btn-dark" @onclick="() => ClaimItem(Item.Id)">
                    Claim item
                </button>
            }

        </div>

        <!-- You can later bind this to Item.ImageUrl or a list of images -->
        <div id="carouselExampleDark" class="carousel carousel-dark slide">
            <div class="carousel-indicators">
                @if (Item.Images is not null && Item.Images.Any())
                {
                    @for (int i = 0; i < Item.Images.Count; i++)
                    {
                        <button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="@i"
                                class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" aria-label="Slide @(i + 1)"></button>
                    }
                }
            </div>

            <div class="carousel-inner">
                @if (Item.Images is not null && Item.Images.Any())
                {
                    @for (int i = 0; i < Item.Images.Count; i++)
                    {
                    <div class = "carousel-item @(i == 0 ? "active" : "")" data-bs-interval="3000">
                        <img src="@Item.Images[i]" class="d-block w-100" style="object-fit:contain; height: 400px;" alt="Item Image">
                    </div>    
                    }
                }
                else
                {
                    <div class="carousel-item active">
                        <p>No image available</p>
                    </div>
                }

            </div>
            @if (Item.Images is not null && Item.Images.Count > 1)
            {
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            }
        </div>

        <div class="pt-4">Item description</div>
        <div class="border"></div>

        <div class="pt-3 fw-bold">ID: @Item.Id</div>

        <div class="pt-3 fw-bold">Brand: @Item.Brand</div>

        <div class="pt-3 fw-bold">Color: @Item.Color</div>

        <div class="pt-3 fw-bold">Unqiue Feature: @Item.UniqueFeatures</div>

        <div class="pt-3 fw-bold">Description:</div>
        <div class="pt-3 pb-5">
            @Item.Description
        </div>
    </div>
}

@code {
    [Parameter] public Listings? Item { get; set; }
    private int appUserId;
    private string? PosterProfileImageUri;
    private string? PosterName;

    protected override async Task OnParametersSetAsync()
    {
        if (Item != null)
        {
            using var context = await DbFactory.CreateDbContextAsync();
            var auth = (await authenticationStateProvider.GetAuthenticationStateAsync()).User;
            var aspNetUserId = auth.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            appUserId = await context.AppUser
                .Where(u => u.AspNetUserId == aspNetUserId)
                .Select(u => u.Id)
                .SingleAsync();


            var posterAppUser = await context.AppUser
                .Where(u => u.Id == Item.UserId)
                .Select(u => new
                {
                    u.AspNetUserId,
                    u.ProfileImageUrl
                }

                ).SingleOrDefaultAsync();

            if (posterAppUser is not null)
            {
                PosterProfileImageUri = posterAppUser.ProfileImageUrl;

                if (!string.IsNullOrEmpty(posterAppUser.AspNetUserId))
                {
                        var posterIdentityUser = await UserManager.FindByIdAsync(posterAppUser.AspNetUserId);
                        PosterName = posterIdentityUser?.FullName;
                }
            }

        }
    }

    private async Task ClaimItem(int listingId)
    {
        using var context = await DbFactory.CreateDbContextAsync();

        var auth = (await authenticationStateProvider.GetAuthenticationStateAsync()).User;
        var aspNetUserId = auth.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        var myAppUserId = await context.AppUser
            .Where(u => u.AspNetUserId == aspNetUserId)
            .Select(u => u.Id)
            .SingleAsync();

        var listing = await context.Listings.FirstAsync(l => l.Id == listingId);

        if (listing.UserId == myAppUserId)
            return; // or show message: can't claim own listing

        var match = await context.Matches.FirstOrDefaultAsync(m =>
            m.ListingId == listingId && m.MatcherUserId == myAppUserId);

        if (match == null)
        {
            match = new Matches
            {
                ListingId = listingId,
                MatcherUserId = myAppUserId,
                DateCreated = DateTime.Now,
                DateModified = DateTime.Now
            };
            context.Matches.Add(match);
            await context.SaveChangesAsync();
        }

        NavigationManager.NavigateTo($"/messages?matchId={match.Id}");
    }

}
