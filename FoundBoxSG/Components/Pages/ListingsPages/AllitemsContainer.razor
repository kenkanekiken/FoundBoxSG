@using FoundBoxSG.Domain
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<FoundBoxSG.Data.FoundBoxSGContext> DbFactory

<div class="container-fluid pt-4">
    <SearchBar @bind-SearchText="searchText" @bind-SearchLocation="searchLocation" />
    <div class="row">
        <SideBar Listings="FilteredListings" OnSelectItem="SelectItem" />
        <ItemDescription Item="SelectedItem"/>
    </div>
</div>
@code {
    private string searchText = "";
    private string searchLocation = "";

    private List<Listings> AllListings = new();
    private Listings? SelectedItem { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        AllListings = await context.Listings
            .OrderByDescending(l => l.DateCreated)   // 🔹 newest first
            .ToListAsync();
        // Default: show the latest listing
        if (AllListings.Any())
        {
            SelectedItem = AllListings.First(); // show latest listing
        }
    }

    private IEnumerable<Listings> FilteredListings =>
            AllListings.Where(x =>
                (string.IsNullOrWhiteSpace(searchText) ||
                    x.Title.Contains(searchText, StringComparison.OrdinalIgnoreCase)) &&
                (string.IsNullOrWhiteSpace(searchLocation) ||
                    x.Location.Contains(searchLocation, StringComparison.OrdinalIgnoreCase)));


    private void SelectItem(Listings item)
    {
        SelectedItem = item;
    }
}
