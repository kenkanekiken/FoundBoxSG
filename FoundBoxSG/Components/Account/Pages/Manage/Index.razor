@page "/Account/Manage"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using FoundBoxSG.Data
@using Microsoft.EntityFrameworkCore
@using FoundBoxSG.Domain
@using Microsoft.AspNetCore.Components.Authorization
@inject IDbContextFactory<FoundBoxSG.Data.FoundBoxSGContext> DbFactory
@inject UserManager<FoundBoxSGUser> UserManager
@inject SignInManager<FoundBoxSGUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<PageTitle>Profile</PageTitle>
    
    
@if (isLoading)
{
    <p><em>Loading user details</em></p>
}
else if (user is null)
{
    <p>User not found or logged in</p>    
}
else
{
<h3>Profile</h3>
    @if (!string.IsNullOrEmpty(statusMessage))               
    {
        <div class="alert alert-success">@statusMessage</div>
    }
    <div class="row">
        <div class="col-md-6">
            <EditForm Model="Input" FormName="profile" OnValidSubmit="OnValidSubmitAsync" method="post">
                <DataAnnotationsValidator/>
                <ValidationSummary class="text-danger" role="alert" />
                <div class="d-flex justify-content-start mb-3"
                style= "width: 100px; height: 100px;">
                @if (!string.IsNullOrEmpty(userProfileImageUri))
                {
                    <img Src="@userProfileImageUri"
                           alt="User Profile Photo"
                             class="rounded-circle border border-dark border-2"
                           style="width: 100px; height: 100px; object-fit: cover; " />
                }
                else
                {
                    <p>
                        No photo available
                    </p>
                }
                </div>
                <div class="form-floating mb-3">
                    <input type="text" value="@username" class="form-control" placeholder="Please choose your username." disabled />
                    <label for="username" class="form-label">Username</label>
                </div>
                <div class="form-floating mb-3">
                    <InputText @bind-Value="Input.FullName" class="form-control" placeholder="Please enter your fullname." />
                    <label for="fullname" class="form-label">FullName</label>
                    <ValidationMessage For="() => Input.FullName" class="text-danger" />
                </div>
                <div class="form-floating mb-3">
                    <InputText @bind-Value="Input.PhoneNumber" class="form-control" placeholder="Please enter your phone number." />
                    <label for="phone-number" class="form-label">Phone number</label>
                    <ValidationMessage For="() => Input.PhoneNumber" class="text-danger" />
                </div>
                <div class="form-floating mb-3">
                    <InputText @bind-Value="Input.Nationality" class="form-control" placeholder="Please enter your nationality." />
                    <label for="nationality" class="form-label">Nationality</label>
                    <ValidationMessage For="() => Input.Nationality" class="text-danger" />
                </div>
                <div class="form-floating mb-3">
                    <InputText @bind-Value="Input.Region" class="form-control" placeholder="Please enter your region." />
                    <label for="region" class="form-label">Region</label>
                    <ValidationMessage For="() => Input.Region" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="image" class="form-label">Change Profile Photo:</label>
                    <InputFile id="image" OnChange="@LoadFile" class="form-control" />
                </div>
                @if (FileErrors.Any())
                {
                <div class="text-danger mt-2">
                    @foreach (var error in FileErrors)
                    {
                        <p class="mb-0">@error</p>    
                    }
                </div>
                }

                <button type="submit" class="w-100 btn btn-lg btn-primary">Save</button>
            </EditForm>
        </div>
    </div>
}
@code {
    private FoundBoxSGUser? user;
    private string? userProfileImageUri;
    private string? username;
    private string? fullname;
    private string? phoneNumber;
    private AppUser? CurrentAppUser;
    private List<string> FileErrors = new List<string>();
    private const int maxFileSize = 5242880;
    private bool isLoading = true;
    private string? statusMessage;


    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // --- START OF AUTHENTICATION CHANGES (Replaces HttpContext/UserAccessor) ---
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        if (principal.Identity is null || !principal.Identity.IsAuthenticated)
        {
            // Use NavigationManager to redirect, as RedirectManager is tied to HttpContext
            NavigationManager.NavigateTo("Account/Login");
            return;
        }

        user = await UserManager.GetUserAsync(principal);
        if (user is null)
        {
            NavigationManager.NavigateTo("Account/Login");
            return;
        }
        username = await UserManager.GetUserNameAsync(user);
        phoneNumber = await UserManager.GetPhoneNumberAsync(user);
        fullname = user.FullName;

        var aspNetUserId = await UserManager.GetUserIdAsync(user);

        using var context = DbFactory.CreateDbContext();

        CurrentAppUser = await context.AppUser
            .FirstOrDefaultAsync(au => au.AspNetUserId == aspNetUserId);
        if (CurrentAppUser is null)
        {
            CurrentAppUser = new AppUser
            {
                AspNetUserId = aspNetUserId,
                DateCreated = DateTime.Now,
                DateModified = DateTime.Now
            };

            context.AppUser.Add(CurrentAppUser);
            await context.SaveChangesAsync();
        }
        if (string.IsNullOrEmpty(Input.Nationality)) Input.Nationality = CurrentAppUser.Nationality;
        if (string.IsNullOrEmpty(Input.Region)) Input.Region = CurrentAppUser.Region;
        if (string.IsNullOrEmpty(Input.PhoneNumber)) Input.PhoneNumber = phoneNumber;
        if (string.IsNullOrEmpty(Input.FullName)) Input.FullName = fullname;
        userProfileImageUri = CurrentAppUser.ProfileImageUrl;

        isLoading = false;
    }

    private async Task LoadFile(InputFileChangeEventArgs e)
    {
        FileErrors.Clear();
        var selectedFile = e.File;

        if (selectedFile is null)
        {
            return;    
        }


        if (selectedFile.Size > maxFileSize)
        {
            FileErrors.Add($"File exceeds the maximum size of {maxFileSize} bytes.");
            StateHasChanged();
            return;
        }

        if (!selectedFile.ContentType.StartsWith("image/"))
        {
            FileErrors.Add($"File is not a supported image format.");
            StateHasChanged();
            return;
        }

        using (var ms = new MemoryStream())
        {
            try
            {
                await selectedFile.OpenReadStream(maxFileSize).CopyToAsync(ms);
                var fileBytes = ms.ToArray();
                String base64String = Convert.ToBase64String(fileBytes);
                userProfileImageUri = $"data:{selectedFile.ContentType};base64,{base64String}";

            }
            catch (Exception ex)
            {
                FileErrors.Add("No valid image files were selected.");
                userProfileImageUri = null;
            }

        }

        StateHasChanged();
    }



    private async Task OnValidSubmitAsync()
    {
        if (user is null) return;
        if (Input.PhoneNumber != phoneNumber)
        {
            var setPhoneResult = await UserManager.SetPhoneNumberAsync(user, Input.PhoneNumber);
            if (!setPhoneResult.Succeeded)
            {
                statusMessage = "Error: Failed to set phone number."; // CHANGED: Use local status
                return;
            }
            phoneNumber = Input.PhoneNumber;
        }
        var newFullName = Input.FullName?.Trim();

        if (!string.IsNullOrWhiteSpace(newFullName) && newFullName != user.FullName)
        {
            user.FullName = newFullName;
            var nameUpdate = await UserManager.UpdateAsync(user);

            if (!nameUpdate.Succeeded)
            {
                statusMessage = "Error: Failed to update full name.";
                return;
            }
        }

        if (CurrentAppUser is not null)
        {

            bool appUserChanged = false;

            if (CurrentAppUser.ProfileImageUrl != userProfileImageUri)
            {
                CurrentAppUser.ProfileImageUrl = userProfileImageUri;
                appUserChanged = true;
            }
            if (CurrentAppUser.Nationality != Input.Nationality)
            {
                CurrentAppUser.Nationality = Input.Nationality;
                appUserChanged = true;    
            }
            if (CurrentAppUser.Region != Input.Region)
            {
                CurrentAppUser.Region= Input.Region;
                appUserChanged = true;
            }

            if (appUserChanged)
            {
                using var context = DbFactory.CreateDbContext();

                context.AppUser.Attach(CurrentAppUser);
                context.Entry(CurrentAppUser).State = EntityState.Modified;

                CurrentAppUser.DateModified = DateTime.Now;

                await context.SaveChangesAsync();
            }
        }

        await SignInManager.RefreshSignInAsync(user);
        statusMessage = "Your profile has been updated";
    }

    private sealed class InputModel
    {
        [Phone]
        [Display(Name = "Phone number")]
        public string? PhoneNumber { get; set; }

        //For AppUser

        [Required]
        [StringLength(100)]
        [Display(Name = "Nationality")]
        public string? Nationality { get; set; }

        [Required]
        [StringLength(100)]
        [Display(Name = "Region")]
        public string? Region { get; set; }

        [Required]
        [StringLength(100)]
        [Display(Name = "Full name")]
        public string? FullName { get; set; }
    }
}
